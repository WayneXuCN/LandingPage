---
/**
 * BaseLayout.astro
 * 全局布局组件，包含 meta、manifest、GA 条件脚本、主题初始化
 */
import '../styles/global.css';
import { SEO } from 'astro-seo';
import { getImage } from 'astro:assets';
import { getLocalImage } from '@lib/localImages';
import { getHrefLang, type Locale } from '@lib/i18n';

interface Props {
  title?: string;
  description?: string;
  author?: string;
  keywords?: string;
  lang?: string;
  ogImage?: string;
  canonicalUrl?: string;
  noindex?: boolean;
  nofollow?: boolean;
}

const {
  title = 'Wenjie Xu',
  description = 'My personal landing page.',
  author = 'Wenjie Xu',
  keywords = 'Landing Page, Astro, Personal Website',
  lang = 'zh_CN',
  ogImage = '/img/og-image.png',
  canonicalUrl,
  noindex = false,
  nofollow = false,
} = Astro.props;

// HTML lang 必须是有效的 BCP47（例如 zh-CN / en-US）。
// 项目内部 locale 使用 zh_CN / en_US，这里做一次安全转换并提供回退。
const htmlLang = (() => {
  if (typeof lang !== 'string' || !lang.trim()) return 'zh-CN';

  // 常见内部格式：zh_CN / en_US
  if (/^[a-z]{2}_[A-Z]{2}$/.test(lang)) {
    return getHrefLang(lang as Locale) || lang.replace('_', '-');
  }

  // 已经是 BCP47（或其他合法值），直接返回
  return lang;
})();

// 构建完整的 OG 图片 URL
// 从 astro.config.mjs 读取 site 配置
// 如果未设置 site，在开发环境使用 localhost，生产环境使用相对路径
const getSiteUrl = () => {
  if (Astro.site?.origin) {
    return Astro.site.origin;
  }

  // 开发环境使用 localhost，生产环境使用相对路径
  return import.meta.env.DEV ? 'http://localhost:4321' : '';
};
const siteUrl = getSiteUrl();

// 如果传入的 ogImage 指向 src/assets/img 下的本地图片，则在构建期生成标准的 OG 尺寸图
const localOgSource = getLocalImage(ogImage);
const ogTransform = localOgSource
  ? await getImage({
      src: localOgSource,
      width: 1200,
      height: 630,
      format: 'jpg',
      quality: 80,
    })
  : null;

const resolvedOgImage = ogTransform?.src ?? ogImage;

// Apple touch icon：同样可以用 getImage() 生成更轻量的 180x180 png
const localAppleTouchSource =
  getLocalImage('/img/apple-touch-icon.png') || getLocalImage('/assets/img/apple-touch-icon.png');
const appleTouchTransform = localAppleTouchSource
  ? await getImage({
      src: localAppleTouchSource,
      width: 180,
      height: 180,
      format: 'png',
    })
  : null;
const appleTouchIconHref = appleTouchTransform?.src ?? '/assets/img/apple-touch-icon.png';

// 处理 OG 图片 URL 和 Canonical URL
const fullOgImage = resolvedOgImage.startsWith('http')
  ? resolvedOgImage
  : siteUrl
    ? `${siteUrl}${resolvedOgImage}`
    : resolvedOgImage;
const fullCanonicalUrl = canonicalUrl || Astro.url.href;

// GA ID 从环境变量获取（PUBLIC_ 前缀表示客户端可用）
const gaId = import.meta.env.PUBLIC_GA_ID;
---

<!doctype html>
<html lang={htmlLang} class='scroll-smooth'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta name='generator' content={Astro.generator} />

    <!-- astro-seo：自动生成 SEO meta 标签 -->
    <SEO
      title={title}
      description={description}
      canonical={fullCanonicalUrl}
      noindex={noindex}
      nofollow={nofollow}
      openGraph={{
        basic: {
          title: title,
          type: 'website',
          image: fullOgImage,
        },
        optional: {
          description: description,
          // Open Graph locale 习惯使用下划线格式（en_US / zh_CN）
          locale:
            typeof lang === 'string'
              ? (lang.includes('_') ? lang : lang.replace('-', '_'))
              : 'en_US',
          siteName: 'Wenjie Xu',
        },
        image: {
          url: fullOgImage,
          alt: title,
          width: 1200,
          height: 630,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        title: title,
        description: description,
        image: fullOgImage,
      }}
      extend={{
        meta: [
          { name: 'author', content: author },
          { name: 'keywords', content: keywords },
        ],
      }}
    />

    <!-- Favicon -->
    <link rel='icon' type='image/x-icon' href='/favicon.ico' />
    <link rel='apple-touch-icon' href={appleTouchIconHref} />

    <!-- Web Manifest -->
    <link rel='manifest' href='/site.webmanifest' />

    <!-- Fonts: use system font stack (avoid render-blocking + third-party font CSS) -->

    <!-- Icons use inline SVG; no external icon font CSS required -->

    <!-- View Transitions 已移除：减少首屏 JS 与潜在阻塞 -->

    <!-- 
      主题初始化脚本
    -->
    <script is:inline>
      (function () {
        function getTheme() {
          if (typeof localStorage !== 'undefined') {
            const stored = localStorage.getItem('theme');
            if (stored === 'dark' || stored === 'light') return stored;
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme() {
          const theme = getTheme();
          document.documentElement.classList.toggle('dark', theme === 'dark');
        }

        // 初始化主题
        applyTheme();

        // 监听系统主题变化（当没有手动设置时）
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (!localStorage.getItem('theme')) {
            document.documentElement.classList.toggle('dark', e.matches);
          }
        });

        // View Transitions：页面切换后重新应用主题
        // astro:after-swap 事件在 DOM 交换完成后触发
        document.addEventListener('astro:after-swap', applyTheme);
      })();
    </script>

    <!-- Google Analytics -->
    {
      gaId && (
        <>
          <script is:inline define:vars={{ gaId }}>
            window.dataLayer = window.dataLayer || []; dataLayer.push(['js', new Date()]);
            dataLayer.push(['config', gaId]);
          </script>
          <script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`} />
        </>
      )
    }
  </head>

  <body
    class='min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300'
  >
    <!-- 
      主内容区域使用 fade 过渡动画
    -->
    <main
      class='container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 py-12 sm:py-16 max-w-8xl'
      transition:animate='fade'
    >
      <slot />
    </main>
  </body>
</html>
