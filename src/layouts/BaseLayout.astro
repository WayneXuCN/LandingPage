---
/**
 * BaseLayout.astro
 * 全局布局组件，包含 meta、manifest、GA 条件脚本、主题初始化
 */
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import { SEO } from 'astro-seo';

interface Props {
  title?: string;
  description?: string;
  author?: string;
  keywords?: string;
  lang?: string;
  ogImage?: string;
  canonicalUrl?: string;
  noindex?: boolean;
  nofollow?: boolean;
}

const {
  title = 'Home',
  description = '',
  author = '',
  keywords = '',
  lang = 'en',
  ogImage = '/assets/img/og-image.png',
  canonicalUrl,
  noindex = false,
  nofollow = false,
} = Astro.props;

// 构建完整的 OG 图片 URL
const siteUrl = Astro.site?.origin || 'https://wenjiexu.site';
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`;
const fullCanonicalUrl = canonicalUrl || Astro.url.href;

// GA ID 从环境变量获取（PUBLIC_ 前缀表示客户端可用）
const gaId = import.meta.env.PUBLIC_GA_ID;
---

<!doctype html>
<html lang={lang} class='scroll-smooth'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta name='generator' content={Astro.generator} />

    <!-- astro-seo：自动生成 SEO meta 标签 -->
    <SEO
      title={title}
      description={description}
      canonical={fullCanonicalUrl}
      noindex={noindex}
      nofollow={nofollow}
      openGraph={{
        basic: {
          title: title,
          type: 'website',
          image: fullOgImage,
        },
        optional: {
          description: description,
          locale: lang === 'zh' ? 'zh_CN' : 'en_US',
          siteName: 'Wenjie Xu',
        },
        image: {
          url: fullOgImage,
          alt: title,
          width: 1200,
          height: 630,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        title: title,
        description: description,
        image: fullOgImage,
      }}
      extend={{
        meta: [
          { name: 'author', content: author },
          { name: 'keywords', content: keywords },
        ],
      }}
    />

    <!-- Favicon -->
    <link rel='icon' type='image/x-icon' href='/favicon.ico' />
    <link rel='apple-touch-icon' href='/assets/img/apple-touch-icon.png' />

    <!-- Web Manifest -->
    <link rel='manifest' href='/site.webmanifest' />

    <!-- Google Fonts: Noto Sans SC-->
    <link rel='preconnect' href='https://fonts.googleapis.com' />
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin />
    <link
      rel='stylesheet'
      href='https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap'
    />

    <!-- Font Awesome CDN -->
    <link
      rel='stylesheet'
      href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
      crossorigin='anonymous'
    />

    <!-- Custom Icons -->
    <link rel='stylesheet' href='/assets/css/custom-icons.css' />

    <!-- 
      View Transitions
    -->
    <ClientRouter />

    <!-- 
      主题初始化脚本
    -->
    <script is:inline>
      (function () {
        function getTheme() {
          if (typeof localStorage !== 'undefined') {
            const stored = localStorage.getItem('theme');
            if (stored === 'dark' || stored === 'light') return stored;
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme() {
          const theme = getTheme();
          document.documentElement.classList.toggle('dark', theme === 'dark');
        }

        // 初始化主题
        applyTheme();

        // 监听系统主题变化（当没有手动设置时）
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (!localStorage.getItem('theme')) {
            document.documentElement.classList.toggle('dark', e.matches);
          }
        });

        // View Transitions：页面切换后重新应用主题
        // astro:after-swap 事件在 DOM 交换完成后触发
        document.addEventListener('astro:after-swap', applyTheme);
      })();
    </script>

    <!-- Google Analytics -->
    {
      gaId && (
        <>
          <script is:inline define:vars={{ gaId }}>
            window.dataLayer = window.dataLayer || []; const gtag = () => dataLayer.push(arguments);
            gtag('js', new Date()); gtag('config', gaId);
          </script>
          <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`} />
        </>
      )
    }
  </head>

  <body
    class='min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300'
  >
    <!-- 
      主内容区域使用 fade 过渡动画
    -->
    <main
      class='container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16 py-12 sm:py-16 max-w-8xl'
      transition:animate='fade'
    >
      <slot />
    </main>
  </body>
</html>
