---
/**
 * Footer.astro
 * 页脚组件，包含版权信息、备案信息、社交链接
 */
import { Icon } from 'astro-icon/components';

interface SocialLink {
  url: string;
  title?: string;
  icon?: string;
  imageUrl?: string;
}

interface IcpInfo {
  text?: string;
  url?: string;
}

interface MpsInfo {
  text?: string;
  url?: string;
  logo?: string;
}

interface FooterData {
  copyright?: string;
  icp?: IcpInfo;
  mps?: MpsInfo;
  socialLinks?: SocialLink[];
}

interface Props {
  footer: FooterData;
}

const { footer } = Astro.props;

if (!footer) {
  return null;
}

const socialLinks = Array.isArray(footer.socialLinks) ? footer.socialLinks : [];

const getIconKind = (iconClass?: string, title?: string) => {
  const v = (iconClass || title || '').toLowerCase();
  if (v.includes('github')) return 'github';
  if (v.includes('google')) return 'google';
  if (v.includes('researchgate') || v.includes('research')) return 'research';
  if (v.includes('envelope') || v.includes('mail')) return 'mail';
  if (v.includes('globe') || v.includes('web') || v.includes('site')) return 'globe';
  return 'link';
};

const getIconName = (kind: string) => {
  switch (kind) {
    case 'github':
      return 'mdi:github';
    case 'google':
      // 用更贴近“Scholar/学术”的通用图标，避免品牌 Logo 引起的风格不一致
      return 'mdi:school-outline';
    case 'research':
      return 'mdi:flask-outline';
    case 'mail':
      return 'mdi:email-outline';
    case 'globe':
      return 'mdi:web';
    default:
      return 'mdi:link-variant';
  }
};

// 动态生成版权信息
const currentYear = new Date().getFullYear();
const startYear = 2024;
const copyrightText =
  footer.copyright
    ?.replace('{startYear}', startYear.toString())
    .replace('{currentYear}', currentYear.toString()) || '';

const { icp, mps } = footer;
---

<footer
  class='pt-8 sm:pt-12 pb-4 sm:pb-6 border-t border-gray-200 dark:border-gray-800 mt-12 sm:mt-16'
>
  <div class='flex flex-col gap-4'>
    {/* 主要内容行：版权信息和社交链接 */}
    <div class='flex justify-between items-center flex-col md:flex-row gap-4 md:gap-0'>
      <div class='flex flex-col items-center md:items-start gap-2'>
        <p class='text-gray-600 dark:text-gray-400 text-sm text-center md:text-left'>
          {copyrightText}
        </p>

        {/* 备案信息 */}
        {
          (icp?.text || mps?.text) && (
            <div class='flex flex-col sm:flex-row items-center justify-center md:justify-start gap-1 sm:gap-2 text-xs text-gray-600 dark:text-gray-300'>
              {/* ICP备案 */}
              {icp?.text && icp?.url && (
                <a
                  href={icp.url}
                  target={icp.url.startsWith('http') ? '_blank' : undefined}
                  rel={icp.url.startsWith('http') ? 'noopener noreferrer' : undefined}
                  class='inline-flex items-center whitespace-nowrap rounded-md -mx-2 px-2 py-2 min-h-[44px] sm:min-h-0 sm:mx-0 sm:px-0 sm:py-0 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-900'
                >
                  {icp.text}
                </a>
              )}

              {/* 分隔符 - 仅在 sm 及以上屏幕显示 */}
              {icp?.text && mps?.text && (
                <span class='hidden sm:inline text-gray-400 select-none'>|</span>
              )}

              {/* 公安备案 */}
              {mps?.text && mps?.url && (
                <a
                  href={mps.url}
                  target={mps.url.startsWith('http') ? '_blank' : undefined}
                  rel={mps.url.startsWith('http') ? 'noopener noreferrer' : undefined}
                  class='inline-flex items-center gap-1 whitespace-nowrap rounded-md -mx-2 px-2 py-2 min-h-[44px] sm:min-h-0 sm:mx-0 sm:px-0 sm:py-0 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-900'
                >
                  {mps?.logo && (
                    <img
                      src={mps.logo}
                      alt='公安备案'
                      class='w-3 h-3 object-contain flex-shrink-0'
                      loading='lazy'
                      decoding='async'
                    />
                  )}
                  <span>{mps.text}</span>
                </a>
              )}
            </div>
          )
        }
      </div>

      {/* 社交链接 */}
      <div class='flex space-x-4 sm:space-x-6'>
        {
          socialLinks.map(link => (
            <a
              href={link.url}
              class='text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors social-icon'
              title={link.title || ''}
              aria-label={link.title || 'Social link'}
              target={link.url?.startsWith('http') ? '_blank' : undefined}
              rel={link.url?.startsWith('http') ? 'noopener noreferrer' : undefined}
            >
              {link.imageUrl ? (
                <img
                  src={link.imageUrl}
                  alt={link.title || 'social-icon'}
                  class='w-full h-full object-contain'
                  loading='lazy'
                  decoding='async'
                />
              ) : (
                (() => {
                  const kind = getIconKind(link.icon, link.title);

                  return (
                    <Icon
                      name={getIconName(kind)}
                      class='w-5 h-5'
                      aria-hidden='true'
                      focusable='false'
                    />
                  );
                })()
              )}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</footer>
