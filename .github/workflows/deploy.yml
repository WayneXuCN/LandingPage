name: æ„å»ºä¸éƒ¨ç½²

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # æ„å»ºä¸æµ‹è¯• Job
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: å®‰è£…ä¾èµ–
        run: bun install

      - name: è¿è¡Œ prebuild (è·å– RSS)
        run: bun run prebuild

      - name: æ„å»º Astro ç«™ç‚¹
        run: bun run build

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: bunx playwright install --with-deps chromium

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: bun run test:e2e

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # éƒ¨ç½² Job (ä»…åœ¨ main åˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œ)
  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    concurrency: production

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: æœåŠ¡å™¨æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            cd /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/LandingPage

            # è®¾ç½®ä»£ç†åŠ é€Ÿ
            git remote set-url origin https://gh.xmly.dev/https://github.com/WayneXuCN/LandingPage
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            git config --global --add safe.directory "$(pwd)"
            git fetch --all --depth=1
            git reset --hard origin/main
            git pull --depth=1

            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            bun install
            bun run build

            # å°† dist æ–‡ä»¶å¤¹å†…å®¹ç§»åŠ¨åˆ° index ç›®å½•
            rm -rf /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index/*
            cp -r dist/* /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index/

            # è®¾ç½®indexæ–‡ä»¶æƒé™ä¸º PHP-FPM ç”¨æˆ·
            chown -R 1000:1000 /opt/1panel/apps/openresty/openresty/www/sites/wenjiexusite/index

            echo "âœ… å·²æˆåŠŸæ‹‰å– main åˆ†æ”¯æœ€æ–°å†…å®¹"
            echo "âœ… æ„å»ºæ–‡ä»¶å·²ç§»åŠ¨åˆ° index ç›®å½•"
            echo "âœ… index ç›®å½•æ–‡ä»¶æƒé™å·²è®¾ç½®ä¸º 1000:1000"
            echo "ğŸš€ éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"
